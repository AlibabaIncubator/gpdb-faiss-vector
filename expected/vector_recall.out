--
-- a regress test use pg_regress for vector_operator
--
-- start_matchignore
-- m/^WARNING:/
-- end_matchignore
CREATE EXTENSION vector_recall;
SELECT array_agg(id) AS ids,
    array_1d_extend(vector) AS vectors
FROM(
        SELECT id,
            (
                SELECT array_agg(gs::REAL) AS vector
                FROM generate_series(id, id + 9) AS gs
            )::REAL [] AS vector
        FROM generate_series(0, 99, 10) AS id
    ) AS tmp;
              ids               |                                                                                                                                               vectors                                                                                                                                               
--------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {0,10,20,30,40,50,60,70,80,90} | {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99}
(1 row)

SELECT faiss_index_create(10, 'IDMap,HNSW32,Flat', 1);
                                                                                                                                                                                                                                                                        faiss_index_create                                                                                                                                                                                                                                                                        
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 \x49784d700a000000000000000000000000001000000000000000100000000000010100000049484e660a00000000000000000000000000100000000000000010000000000001010000000600000000000000000000000000ef3f0000008000009f3f000000e000004f3f000000e00000ff3e000000e00100af3e000000c002005f3e070000000000000000000000400000006000000080000000a0000000c0000000e00000000000000000000000010000000000000000000000000000000000000000000000ffffffffffffffff280000001000000001000000497846320a000000000000000000000000001000000000000000100000000000010100000000000000000000000000000000000000
(1 row)

SELECT faiss_index_train(
        faiss_index_create(10, 'IVF16,PQ5', 1),
        array_agg(gs::REAL),
        10
    )
FROM generate_series(1, 256 * 10) AS gs;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             faiss_index_train                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 \x497750510a000000000000000000000000001000000000000000100000000000010100000010000000000000000100000000000000497846320a0000001000000000000000000010000000000000001000000000000101000000a0000000000000000000e3440020e3440040e3440060e3440080e34400a0e34400c0e34400e0e3440000e4440020e44400401d4500501d4500601d4500701d4500801d4500901d4500a01d4500b01d4500c01d4500d01d450090184500a0184500b0184500c0184500d0184500e0184500f018450000194500101945002019450000034300000443000005430000064300000743000008430000094300000a4300000b4300000c4300c0a04400e0a0440000a1440020a1440040a1440060a1440080a14400a0a14400c0a14400e0a1440080c3430000c4430080c4430000c5430080c5430000c6430080c6430000c7430080c7430000c8430080864400a0864400c0864400e08644000087440020874400408744006087440080874400a087440020b9440040b9440060b9440080b94400a0b94400c0b94400e0b9440000ba440020ba440040ba4400300f4500400f4500500f4500600f4500700f4500800f4500900f4500a00f4500b00f4500c00f4500005644004056440080564400c0564400005744004057440080574400c0574400005844004058440030144500401445005014450060144500701445008014450090144500a0144500b0144500c0144500c01d4400001e4400401e4400801e4400c01e4400001f4400401f4400801f4400c01f44000020440120f5440140f5440160f5440180f54401a0f54401c0f54401e0f5440100f6440120f6440140f6440000cf440020cf440040cf440060cf440080cf4400a0cf4400c0cf4400e0cf440000d0440020d04400400945005009450060094500700945008009450090094500a0094500b0094500c0094500d009450060024500700245008002450090024500a0024500b0024500c0024500d0024500e0024500f002450000000000000000000105000000000000000a0000000000000005000000000000000800000000000000000a000000000000000002c3000002c30000f0c20000f0c20000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000f0420000f04200000243000002430000f0c20000f0c20000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000f0420000f0420000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000d2420000d2420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c4200008242000082420000964200009642000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824210008cc210008cc2200070c2200070c2200048c2200048c2200020c2200020c24000f0c14000f0c14000a0c14000a0c1800020c1800020c1000000b9000000b980ff1f4180ff1f41c0ff9f41c0ff9f41c0ffef41c0ffef41e0ff1f42e0ff1f42e0ff4742e0ff4742e0ff6f42e0ff6f4200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c420000344200003442000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f0410000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000002c3000002c30000f0c20000f0c20000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000f0420000f04200000243000002430000f0c20000f0c20000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000f0420000f0420000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000d2420000d2420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c4200008242000082420000964200009642000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824210008cc210008cc2200070c2200070c2200048c2200048c2200020c2200020c24000f0c14000f0c14000a0c14000a0c1800020c1800020c1000000b9000000b980ff1f4180ff1f41c0ff9f41c0ff9f41c0ffef41c0ffef41e0ff1f42e0ff1f42e0ff4742e0ff4742e0ff6f42e0ff6f4200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c420000344200003442000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f0410000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000002c3000002c30000f0c20000f0c20000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000f0420000f04200000243000002430000f0c20000f0c20000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000f0420000f0420000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000d2420000d2420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c4200008242000082420000964200009642000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824210008cc210008cc2200070c2200070c2200048c2200048c2200020c2200020c24000f0c14000f0c14000a0c14000a0c1800020c1800020c1000000b9000000b980ff1f4180ff1f41c0ff9f41c0ff9f41c0ffef41c0ffef41e0ff1f42e0ff1f42e0ff4742e0ff4742e0ff6f42e0ff6f4200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c420000344200003442000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f0410000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000002c3000002c30000f0c20000f0c20000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000f0420000f04200000243000002430000f0c20000f0c20000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000f0420000f0420000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000d2420000d2420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c4200008242000082420000964200009642000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824210008cc210008cc2200070c2200070c2200048c2200048c2200020c2200020c24000f0c14000f0c14000a0c14000a0c1800020c1800020c1000000b9000000b980ff1f4180ff1f41c0ff9f41c0ff9f41c0ffef41c0ffef41e0ff1f42e0ff1f42e0ff4742e0ff4742e0ff6f42e0ff6f4200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c420000344200003442000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f0410000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000002c3000002c30000f0c20000f0c20000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000f0420000f04200000243000002430000f0c20000f0c20000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000f0420000f0420000dcc20000dcc20000c8c20000c8c20000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000b4420000b4420000c8420000c8420000dc420000dc420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000d2420000d2420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000d2c20000d2c20000bec20000bec20000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824200009642000096420000aa420000aa420000be420000be420000b4c20000b4c20000a0c20000a0c200008cc200008cc2000070c2000070c2000048c2000048c2000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000484200004842000070420000704200008c4200008c420000a0420000a0420000aac20000aac2000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c4200008242000082420000964200009642000096c2000096c2000082c2000082c200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000082420000824210008cc210008cc2200070c2200070c2200048c2200048c2200020c2200020c24000f0c14000f0c14000a0c14000a0c1800020c1800020c1000000b9000000b980ff1f4180ff1f41c0ff9f41c0ff9f41c0ffef41c0ffef41e0ff1f42e0ff1f42e0ff4742e0ff4742e0ff6f42e0ff6f4200005cc200005cc2000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42000034420000344200005c4200005c42000034c2000034c200000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c420000344200003442000020c2000020c20000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100002042000020420000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f0410000f0c10000f0c10000a0c10000a0c1000020c1000020c1000000000000000000002041000020410000a0410000a0410000f0410000f04100000cc200000cc20000c8c10000c8c1000070c1000070c10000a0c00000a0c00000a0400000a04000007041000070410000c8410000c84100000c4200000c42696c617210000000000000000500000000000000737072730000000000000000
(1 row)

SELECT faiss_index_add(
        faiss_index_create(10, 'IDMap,HNSW32,Flat', 1),
        ARRAY [0,1,2,3,4,5,6,7,8,9],
        10,
        ARRAY [1]
    );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     faiss_index_add                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 \x49784d700a000000010000000000000000001000000000000000100000000000010100000049484e660a00000001000000000000000000100000000000000010000000000001010000000600000000000000000000000000ef3f0000008000009f3f000000e000004f3f000000e00000ff3e000000e00100af3e000000c002005f3e070000000000000000000000400000006000000080000000a0000000c0000000e00000000100000000000000010000000200000000000000000000000000000040000000000000004000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000280000001000000001000000497846320a00000001000000000000000000100000000000000010000000000001010000000a00000000000000000000000000803f0000004000004040000080400000a0400000c0400000e040000000410000104101000000000000000100000000000000
(1 row)

SELECT faiss_index_set_runtime_parameters(
        faiss_index_create(10, 'IDMap,HNSW32,Flat', 1),
        'efSearch=80'
    );
                                                                                                                                                                                                                                                                faiss_index_set_runtime_parameters                                                                                                                                                                                                                                                                
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 \x49784d700a000000000000000000000000001000000000000000100000000000010100000049484e660a00000000000000000000000000100000000000000010000000000001010000000600000000000000000000000000ef3f0000008000009f3f000000e000004f3f000000e00000ff3e000000e00100af3e000000c002005f3e070000000000000000000000400000006000000080000000a0000000c0000000e00000000000000000000000010000000000000000000000000000000000000000000000ffffffffffffffff280000005000000001000000497846320a000000000000000000000000001000000000000000100000000000010100000000000000000000000000000000000000
(1 row)

SELECT faiss_index_reset(
        faiss_index_add(
            faiss_index_create(10, 'IDMap,HNSW32,Flat', 1),
            ARRAY [0,1,2,3,4,5,6,7,8,9],
            10,
            ARRAY [1]
        )
    );
                                                                                                                                                                                                                                                                        faiss_index_reset                                                                                                                                                                                                                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 \x49784d700a000000000000000000000000001000000000000000100000000000010100000049484e660a00000000000000000000000000100000000000000010000000000001010000000600000000000000000000000000ef3f0000008000009f3f000000e000004f3f000000e00000ff3e000000e00100af3e000000c002005f3e070000000000000000000000400000006000000080000000a0000000c0000000e00000000000000000000000010000000000000000000000000000000000000000000000ffffffffffffffff280000001000000001000000497846320a000000000000000000000000001000000000000000100000000000010100000000000000000000000000000000000000
(1 row)

CREATE TABLE vector_queried (id BIGINT, vector REAL []) DISTRIBUTED BY (id);
INSERT INTO vector_queried
SELECT id,
    (
        SELECT array_agg(CAST(gs AS REAL)) AS vector
        FROM generate_series(id, id + 9) AS gs
    )
FROM generate_series(0, 99999, 10) AS id;
CREATE TABLE vector_query (id BIGINT, vector REAL []) DISTRIBUTED BY (id);
INSERT INTO vector_query
SELECT id,
    (
        SELECT array_agg(CAST(gs AS REAL) + 0.5) AS vector
        FROM generate_series(id, id + 9) AS gs
    )
FROM generate_series(0, 99999, 10005) AS id;
SELECT (m).query_idx,
    unnest((m).vector_idxs) AS vector_idx,
    unnest((m).distances) AS distance
FROM (
        SELECT faiss_index_search(
                index_table.faiss_index,
                queries.vectors,
                10,
                5,
                queries.ids,
                FALSE
            ) AS m
        FROM (
                SELECT create_index_agg(
                        vector,
                        'IDMap,HNSW32,Flat',
                        id,
                        1,
                        'efSearch=80'
                    ) AS faiss_index
                FROM vector_queried
            ) AS index_table,
            (
                SELECT array_agg(id) AS ids,
                    array_1d_extend(vector) AS vectors
                FROM vector_query
            ) AS queries
    ) AS foo
ORDER BY query_idx,
    distance;
 query_idx | vector_idx | distance 
-----------+------------+----------
         0 |          0 |      2.5
         0 |         10 |    902.5
         0 |         20 |   3802.5
         0 |         30 |   8702.5
         0 |         40 |  15602.5
     10005 |      10010 |    202.5
     10005 |      10000 |    302.5
     10005 |      10020 |   2102.5
     10005 |       9990 |   2402.5
     10005 |      10030 |   6002.5
     20010 |      20010 |      2.5
     20010 |      20020 |    902.5
     20010 |      20000 |   1102.5
     20010 |      20030 |   3802.5
     20010 |      19990 |   4202.5
     30015 |      30020 |    202.5
     30015 |      30010 |    302.5
     30015 |      30030 |   2102.5
     30015 |      30000 |   2402.5
     30015 |      30040 |   6002.5
     40020 |      40020 |      2.5
     40020 |      40030 |    902.5
     40020 |      40010 |   1102.5
     40020 |      40040 |   3802.5
     40020 |      40000 |   4202.5
     50025 |      50030 |    202.5
     50025 |      50020 |    302.5
     50025 |      50040 |   2102.5
     50025 |      50010 |   2402.5
     50025 |      50050 |   6002.5
     60030 |      60030 |      2.5
     60030 |      60040 |    902.5
     60030 |      60020 |   1102.5
     60030 |      60050 |   3802.5
     60030 |      60010 |   4202.5
     70035 |      70040 |    202.5
     70035 |      70030 |    302.5
     70035 |      70050 |   2102.5
     70035 |      70020 |   2402.5
     70035 |      70060 |   6002.5
     80040 |      80040 |      2.5
     80040 |      80050 |    902.5
     80040 |      80030 |   1102.5
     80040 |      80060 |   3802.5
     80040 |      80020 |   4202.5
     90045 |      90050 |    202.5
     90045 |      90040 |    302.5
     90045 |      90060 |   2102.5
     90045 |      90030 |   2402.5
     90045 |      90070 |   6002.5
(50 rows)

SELECT (m).*
FROM (
        SELECT faiss_index_search(
                faiss_index_add(
                    faiss_index_create(10, 'IDMap,HNSW32,Flat'),
                    querieds.vectors,
                    10,
                    querieds.ids
                ),
                queries.vectors,
                10,
                5,
                queries.ids,
                TRUE
            ) AS m
        FROM (
                SELECT array_agg(id) AS ids,
                    array_1d_extend(vector) AS vectors
                FROM vector_queried
            ) AS querieds,
            (
                SELECT array_agg(id) AS ids,
                    array_1d_extend(vector) AS vectors
                FROM vector_query
            ) AS queries
    ) AS foo
ORDER BY query_idx;
                                   query_vector                                    | query_idx |           vector_idxs           |             distances              
-----------------------------------------------------------------------------------+-----------+---------------------------------+------------------------------------
 {0.5,1.5,2.5,3.5,4.5,5.5,6.5,7.5,8.5,9.5}                                         |         0 | {0,10,20,30,40}                 | {2.5,902.5,3802.5,8702.5,15602.5}
 {10005.5,10006.5,10007.5,10008.5,10009.5,10010.5,10011.5,10012.5,10013.5,10014.5} |     10005 | {10010,10000,10020,9990,10030}  | {202.5,302.5,2102.5,2402.5,6002.5}
 {20010.5,20011.5,20012.5,20013.5,20014.5,20015.5,20016.5,20017.5,20018.5,20019.5} |     20010 | {20010,20020,20000,20030,19990} | {2.5,902.5,1102.5,3802.5,4202.5}
 {30015.5,30016.5,30017.5,30018.5,30019.5,30020.5,30021.5,30022.5,30023.5,30024.5} |     30015 | {30020,30010,30030,30000,30040} | {202.5,302.5,2102.5,2402.5,6002.5}
 {40020.5,40021.5,40022.5,40023.5,40024.5,40025.5,40026.5,40027.5,40028.5,40029.5} |     40020 | {40020,40030,40010,40040,40000} | {2.5,902.5,1102.5,3802.5,4202.5}
 {50025.5,50026.5,50027.5,50028.5,50029.5,50030.5,50031.5,50032.5,50033.5,50034.5} |     50025 | {50030,50020,50040,50010,50050} | {202.5,302.5,2102.5,2402.5,6002.5}
 {60030.5,60031.5,60032.5,60033.5,60034.5,60035.5,60036.5,60037.5,60038.5,60039.5} |     60030 | {60030,60040,60020,60050,60010} | {2.5,902.5,1102.5,3802.5,4202.5}
 {70035.5,70036.5,70037.5,70038.5,70039.5,70040.5,70041.5,70042.5,70043.5,70044.5} |     70035 | {70040,70030,70050,70020,70060} | {202.5,302.5,2102.5,2402.5,6002.5}
 {80040.5,80041.5,80042.5,80043.5,80044.5,80045.5,80046.5,80047.5,80048.5,80049.5} |     80040 | {80040,80050,80030,80060,80020} | {2.5,902.5,1102.5,3802.5,4202.5}
 {90045.5,90046.5,90047.5,90048.5,90049.5,90050.5,90051.5,90052.5,90053.5,90054.5} |     90045 | {90050,90040,90060,90030,90070} | {202.5,302.5,2102.5,2402.5,6002.5}
(10 rows)

SELECT (m).*
FROM (
        SELECT faiss_index_range_search(
                index_table.faiss_index,
                queries.vectors,
                10,
                100::REAL,
                queries.ids,
                FALSE
            ) AS m
        FROM (
                SELECT create_index_agg(
                        vector,
                        'IVF32,Flat',
                        id,
                        1,
                        NULL
                    ) AS faiss_index
                FROM vector_queried
            ) AS index_table,
            (
                SELECT array_agg(id) AS ids,
                    array_1d_extend(vector) AS vectors
                FROM vector_query
            ) AS queries
    ) AS foo
ORDER BY query_idx;
 query_vector | query_idx | vector_idxs | distances 
--------------+-----------+-------------+-----------
              |         0 | {0}         | {2.5}
              |     10005 | {}          | {}
              |     20010 | {20010}     | {2.5}
              |     30015 | {}          | {}
              |     40020 | {40020}     | {2.5}
              |     50025 | {}          | {}
              |     60030 | {60030}     | {2.5}
              |     70035 | {}          | {}
              |     80040 | {80040}     | {2.5}
              |     90045 | {}          | {}
(10 rows)

SELECT (m).*
FROM (
        SELECT (topk_merge(idxs, distance, 5)) AS m
        FROM (
                SELECT (
                        SELECT array_agg(CAST(gs AS BIGINT)) AS idxs
                        FROM generate_series(id, id + 30, 7) AS gs
                    ),
                    (
                        SELECT array_agg(CAST(gs + 100 AS REAL)) AS distance
                        FROM generate_series(id, id + 30, 7) AS gs
                    )
                FROM generate_series(0, 9, 3) AS id
            ) AS tmp_table
    ) AS foo;
    idxs     |       distances       
-------------+-----------------------
 {0,3,6,7,9} | {100,103,106,107,109}
(1 row)

CREATE TABLE index_table AS (
    SELECT sharding_id,
        md5(faiss_index) AS k,
        faiss_index
    FROM (
            SELECT CAST(id % 30 AS INT) AS sharding_id,
                create_index_agg(
                    vector,
                    'IVF1,Flat',
                    id,
                    1,
                    NULL
                ) AS faiss_index
            FROM vector_queried
            GROUP BY sharding_id
        ) AS foo
) DISTRIBUTED BY (sharding_id);
SELECT (m).*
FROM (
        SELECT faiss_index_search(
                faiss_index,
                ARRAY [0.5,1.5,2.5,3.5,4.5,5.5,6.5,7.5,8.5,9.5],
                10,
                5,
                NULL,
                TRUE,
                k
            ) AS m
        FROM index_table
        WHERE sharding_id = 0
    ) AS foo;
               query_vector                | query_idx |   vector_idxs    |              distances              
-------------------------------------------+-----------+------------------+-------------------------------------
 {0.5,1.5,2.5,3.5,4.5,5.5,6.5,7.5,8.5,9.5} |           | {0,30,60,90,120} | {2.5,8702.5,35402.5,80102.5,142802}
(1 row)

SELECT (m).*
FROM (
        SELECT faiss_index_range_search(
                faiss_index,
                ARRAY [0.5,1.5,2.5,3.5,4.5,5.5,6.5,7.5,8.5,9.5],
                10,
                100::REAL,
                NULL,
                TRUE,
                k
            ) AS m
        FROM index_table
        WHERE sharding_id = 0
    ) AS foo;
               query_vector                | query_idx | vector_idxs | distances 
-------------------------------------------+-----------+-------------+-----------
 {0.5,1.5,2.5,3.5,4.5,5.5,6.5,7.5,8.5,9.5} |           | {0}         | {2.5}
(1 row)

SELECT query_idx,
    idx,
    distance,
    ranking
FROM (
        SELECT (m).query_idx,
            topk_merge((m).vector_idxs, (m).distances, 5) AS t
        FROM (
                SELECT faiss_index_search(
                        index_table.faiss_index,
                        queries.vectors,
                        10,
                        5,
                        queries.ids,
                        FALSE
                    ) AS m
                FROM index_table,
                    (
                        SELECT array_agg(id) AS ids,
                            array_1d_extend(vector) AS vectors
                        FROM vector_query
                    ) AS queries
            ) local_topk_table
        GROUP BY (m).query_idx
    ) AS global_topk_table,
    LATERAL ROWS
FROM (unnest((t).idxs), unnest((t).distances)) WITH ORDINALITY ALIAS (idx, distance, ranking)
ORDER BY query_idx,
    distance;
 query_idx |  idx  | distance | ranking 
-----------+-------+----------+---------
         0 |     0 |      2.5 |       1
         0 |    10 |    902.5 |       2
         0 |    20 |   3802.5 |       3
         0 |    30 |   8702.5 |       4
         0 |    40 |  15602.5 |       5
     10005 | 10010 |    202.5 |       1
     10005 | 10000 |    302.5 |       2
     10005 | 10020 |   2102.5 |       3
     10005 |  9990 |   2402.5 |       4
     10005 | 10030 |   6002.5 |       5
     20010 | 20010 |      2.5 |       1
     20010 | 20020 |    902.5 |       2
     20010 | 20000 |   1102.5 |       3
     20010 | 20030 |   3802.5 |       4
     20010 | 19990 |   4202.5 |       5
     30015 | 30020 |    202.5 |       1
     30015 | 30010 |    302.5 |       2
     30015 | 30030 |   2102.5 |       3
     30015 | 30000 |   2402.5 |       4
     30015 | 30040 |   6002.5 |       5
     40020 | 40020 |      2.5 |       1
     40020 | 40030 |    902.5 |       2
     40020 | 40010 |   1102.5 |       3
     40020 | 40040 |   3802.5 |       4
     40020 | 40000 |   4202.5 |       5
     50025 | 50030 |    202.5 |       1
     50025 | 50020 |    302.5 |       2
     50025 | 50040 |   2102.5 |       3
     50025 | 50010 |   2402.5 |       4
     50025 | 50050 |   6002.5 |       5
     60030 | 60030 |      2.5 |       1
     60030 | 60040 |    902.5 |       2
     60030 | 60020 |   1102.5 |       3
     60030 | 60050 |   3802.5 |       4
     60030 | 60010 |   4202.5 |       5
     70035 | 70040 |    202.5 |       1
     70035 | 70030 |    302.5 |       2
     70035 | 70050 |   2102.5 |       3
     70035 | 70020 |   2402.5 |       4
     70035 | 70060 |   6002.5 |       5
     80040 | 80040 |      2.5 |       1
     80040 | 80050 |    902.5 |       2
     80040 | 80030 |   1102.5 |       3
     80040 | 80060 |   3802.5 |       4
     80040 | 80020 |   4202.5 |       5
     90045 | 90050 |    202.5 |       1
     90045 | 90040 |    302.5 |       2
     90045 | 90060 |   2102.5 |       3
     90045 | 90030 |   2402.5 |       4
     90045 | 90070 |   6002.5 |       5
(50 rows)

DROP TABLE vector_queried;
DROP TABLE vector_query;
DROP TABLE index_table;
DROP EXTENSION vector_recall;
